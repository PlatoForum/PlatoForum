<% content_for :title, @topic.name + " | " + @comment.display_abstract %>
<% content_for :og_title, "評論「" + @topic.name + "」" %>
<% content_for :og_description, @comment.body %>

<ul class="breadcrumb" style="margin-bottom: 5px;">
  <li><%= link_to "主頁", root_path %></li>
  <li><%= link_to "議題", "/list?sort=popularity" %></li>
  <li><%= link_to @topic.name, "/#{@topic.permalink}/" %></li>
  <li class="active">檢視評論</li>
</ul>

<div class="page-header">
  <h2><%= @comment.topic.name %></h2>
  <p class = "text-muted"><%= auto_link(simple_format(sanitize @topic.description, tags: %w(a p br)), :all, :target => '_blank') %></p>
</div>

<div class="row">
  <div class="col-xs-12">
    <div class="expandable-boxes" name="main-well">

      <div class="expandable-box expandable-box-main main">
        <div id="main-container" class="well main-well">
          <%= render 'comment_body' %>
        </div>
      </div>

      <div class="expandable-box expandable-box-1 side">
        <div class="panel panel-default">
          <div class="panel-heading" valign="center">
            <h3 class="panel-title">
              相關評論
            </h3>
          </div>

          <div class="panel-body" id="ref-container">
            <table class="table table-striped table-hover ">
              <tbody>
                <% if @comment.neighbors.nil? %>
                  <% @comment.stance.comments[0,5].each do |comment| %>
                    <tr class="show_comment_tr" id="tr_<%= comment.id %>" onclick="click_tr('<%= comment.id %>');">
                    <% unless session[:user_id].nil? %>
                    <td width="10" class="read_<%= comment.id %>">
                      <% if @proxy.read_comments.find(comment.id) %>
                      <span class="label label-default"><i class="fa fa-check fa-fw"></i> </span>
                      <% else %>
                      <span class="label label-warning"><i class="fa fa-exclamation fa-fw"></i> </span>
                      <% end %>
                    </td>
                    <% end %>
                    <td class="td_short" id="td_<%= comment.id %>_short">
                      <span class="text-muted"><% if (comment.owner == @proxy)%>你<%else%><%=comment.owner.display_name%><%end%></span><br>
                      <span class="text-default"><%= comment.display_abstract_long %></span>
                    </td>
                  </tr>
                  <% end %>
                <% else %>
                  <% @comment.neighbors.each do |comment_id| %>
                  <% comment = Comment.find(comment_id) %>
                  <tr class="show_comment_tr" id="tr_<%= comment.id %>" onclick="click_tr('<%= comment.id %>');">
                    <% unless session[:user_id].nil? %>
                    <td width="10" class="read_<%= comment.id %>">
                      <% if @proxy.read_comments.find(comment.id) %>
                      <span class="label label-default"><i class="fa fa-check fa-fw"></i> </span>
                      <% else %>
                      <span class="label label-warning"><i class="fa fa-exclamation fa-fw"></i> </span>
                      <% end %>
                    </td>
                    <% end %>
                    <td class="td_short" id="td_<%= comment.id %>_short">
                      <span class="text-muted"><% if (comment.owner == @proxy)%>你<%else%><%=comment.owner.display_name%><%end%></span><br>
                      <span class="text-default"><%= comment.display_abstract_long %></span>
                    </td>
                  </tr>
                  <% end %>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="reply_modals">
  <% unless session[:user_id].nil? %>
  <%= render 'comments/modal_reply_comment' %>
  <% end %>
</div>

<script type="text/javascript">
$(function(){
  var imgStr = "\.(jpg|gif|png)+"
  var youtubeStr = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/;

  // Expand <a /> with its associate application, ex. img, youtube
  $("#main-container .comment_bodies a").filter(function(){
    // image url
    var url = $(this).attr("href");
    if( url.match(imgStr)) {
      $(this).html($("<img>").attr("src",url).addClass("comment_img"));
    }
    // youtube url
    var yt_match = url.match(youtubeStr);  // dessemble youtube url into fields
    if( yt_match && yt_match[7].length==11) {

      $(this).replaceWith("<div class='youtube-iframe'><iframe src='//www.youtube.com/embed/" + yt_match[7] + "' frameborder='0' allowfullscreen></iframe></div>");
    }
  });
})

function click_comment_link(data) {
  window.location.href = "/<%= @topic.permalink %>/comment_" + data;
}

function click_tr(data) {
  window.location.href = "/<%= @topic.permalink %>/comment_" + data;
};
</script>