<div class="row">
  <% only_one_stance = (@topic.stances.count == 1) %>
  <% @topic.stances.sort!{|a,b| a.number <=> b.number}.each do |stance| %>
  <div id="btn_stance<%= stance.number %>" class="btn_stance col-md-1">
    <p class="bs-component">
      <a class="btn btn-block <%= stance.panel.nil? ? "btn-default" : "btn-"+stance.panel %>"><%= stance.description.nil? ? "立場#{stance.number}"  : stance.description %></a>
    </p>
  </div>
  <div id="col_stance<%= stance.number %>" class="col_stance col-md-<%= 12 / @topic.stances.count %>">
    <div class="bs-component">
      <div class="panel <%= stance.panel.nil? ? "panel-default" : "panel-"+stance.panel %>">
        <a id="click_stance<%= stance.number %>" class="click_stance">
        <div class="panel-heading">
          <h3 class="panel-title">
            <% if only_one_stance %>
              未分類
            <% else %>
              <%= stance.description.nil? ? "立場#{stance.number}"  : stance.description %>
            <% end %>
          </h3>
        </div>
        </a>

        <div class="panel-body">
          
          <% if stance.comments.count == 0 %>
            <p class="text-muted">這裡有點冷清⋯⋯</p>

          <% else %>

            <table class="table table-striped table-hover ">
              <tbody id="comment_list_stance<%= stance.number %>">
                <% first_item = true %>
                <% stance.comments.sort!{|b,a| a.importance_factor <=> b.importance_factor}.first(5).each do |comment| %>
                  <tr onClick="document.location = '/<%= @topic.permalink%>/comment_<%= comment.id %>';">
                    <% unless session[:user_id].nil? %>
                    <td width="10">
                      <% if @proxy.read_comments.find(comment.id) %>
                        <span class="label label-default"><i class="fa fa-check fa-fw"></i> </span>
                      <% else %>
                        <span class="label label-warning"><i class="fa fa-exclamation fa-fw"></i> </span>
                      <% end %>
                    </td>
                    <% end %>
                    <td><span class="text-muted"><% if (comment.owner == @proxy)%>你<%else%><%=comment.owner.display_name%><%end%></span>：<% if first_item %><%= comment.subject %><br><% end %><span class="text-default"><%= first_item ? comment.display_body_short : comment.display_abstract %></span></td>
                    <td class="text-primary visible-sm" align="right"><% if comment.doc.strftime("%F") == Time.zone.now.strftime("%F") %>今天 <%= comment.doc.strftime("%T") %><% else %><%= comment.doc.strftime("%F") %><% end %></td>
                  </tr>
                  <% first_item = false %>
                <% end %>
              </tbody>
            </table> 

          <% end %>
          
          <% if stance.comments.count > 5 %>
          <center><a id="show_more_stance<%= stance.number %>" href="/<%= @topic.permalink %>/comments/more_stance_<%= stance.number %>/5" data-remote="true">更多⋯⋯</a></center>
          <% end %>
        </div>
      </div>
    </div>
    </div>
    <script type="text/javascript">
      $("#click_stance<%= stance.number %>").click(function (){
        if ($("#click_stance<%= stance.number %>").hasClass("expanded")) {
          $(".btn_stance").hide();
          $(".col_stance").show();
          $(".col_stance").removeClass("col-md-<%= 13 - @topic.stances.count %> panel-expanded").addClass("col-md-<%= 12 / @topic.stances.count %>");
          $(".click_stance").removeClass("expanded");
        }
        else {
          $(".col_stance").hide();
          $(".btn_stance").show();
          $("#btn_stance<%= stance.number %>").hide()
          $("#col_stance<%= stance.number %>").toggle()
          $("#col_stance<%= stance.number %>").removeClass("col-md-<%= 12 / @topic.stances.count %>").addClass( "col-md-<%= 13 - @topic.stances.count %>" );
          $(".click_stance").addClass( "expanded" );
        }
      });
      $("#btn_stance<%= stance.number %>").click(function (){
        $(".col_stance").hide();
        $(".btn_stance").show();
        $("#btn_stance<%= stance.number %>").hide()
        $("#col_stance<%= stance.number %>").show()
        $("#col_stance<%= stance.number %>").removeClass("col-md-<%= 12 / @topic.stances.count %>").addClass( "col-md-<%= 13 - @topic.stances.count %>" );
      });
    </script>
  <% end %>
</div>
  
<script type="text/javascript">
  $(function() {
    $(".btn_stance").hide();
  });
</script>

